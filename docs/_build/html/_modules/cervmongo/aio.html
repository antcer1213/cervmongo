

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>cervmongo.aio &mdash; cervmongo 0.1.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> cervmongo
          

          
            
            <img src="../../_static/logo_cropped.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cervmongo.html">cervmongo package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">cervmongo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../cervmongo.html">cervmongo</a> &raquo;</li>
        
      <li>cervmongo.aio</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for cervmongo.aio</h1><div class="highlight"><pre>
<span></span><span class="c1">#  aio.py</span>
<span class="c1">#</span>
<span class="c1">#  Copyright 2020 Anthony &quot;antcer1213&quot; Cervantes &lt;anthony.cervantes@cerver.info&gt;</span>
<span class="c1">#</span>
<span class="c1">#  MIT License</span>
<span class="c1">#</span>
<span class="c1">#  Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c1">#  of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="c1">#  in the Software without restriction, including without limitation the rights</span>
<span class="c1">#  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1">#  copies of the Software, and to permit persons to whom the Software is</span>
<span class="c1">#  furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1">#  The above copyright notice and this permission notice shall be included in all</span>
<span class="c1">#  copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1">#  THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c1">#  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c1">#  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c1">#  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c1">#  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="c1">#  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="c1">#  SOFTWARE.</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SUPPORT_ASYNCIO_CLIENT&quot;</span><span class="p">,</span> <span class="s2">&quot;SUPPORT_ASYNCIO_BUCKET&quot;</span><span class="p">,</span> <span class="s2">&quot;get_async_client&quot;</span><span class="p">,</span> <span class="s2">&quot;get_async_doc&quot;</span><span class="p">,</span> <span class="s2">&quot;AsyncIOClient&quot;</span><span class="p">,</span> <span class="s2">&quot;AsyncIODoc&quot;</span><span class="p">]</span>

<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span> <span class="k">as</span> <span class="n">os_path</span>
<span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">WriteConcern</span>
<span class="kn">from</span> <span class="nn">dateutil.parser</span> <span class="kn">import</span> <span class="n">parse</span> <span class="k">as</span> <span class="n">dateparse</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">jsonschema</span> <span class="kn">import</span> <span class="n">validate</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">cervmongo.models</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">GenericResponse</span><span class="p">,</span>
                <span class="n">StandardResponse</span><span class="p">,</span>
                <span class="n">MongoListResponse</span><span class="p">,</span>
                <span class="n">MongoDictResponse</span><span class="p">,</span>
                <span class="p">)</span>
<span class="kn">from</span> <span class="nn">cervmongo.vars</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">StringEnum</span><span class="p">,</span>
                <span class="n">IntEnum</span><span class="p">,</span>
                <span class="n">PAGINATION_SORT_FIELDS</span><span class="p">,</span>
                <span class="n">ENUM</span><span class="p">,</span>
                <span class="n">DOC_ID</span><span class="p">,</span>
                <span class="p">)</span>
<span class="kn">from</span> <span class="nn">cervmongo.utils</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">get_file_meta_information</span><span class="p">,</span>
                <span class="n">parse_string_header</span><span class="p">,</span>
                <span class="n">format_string_for_id</span><span class="p">,</span>
                <span class="n">current_datetime</span><span class="p">,</span>
                <span class="n">file_and_fileobj</span><span class="p">,</span>
                <span class="n">detect_mimetype</span><span class="p">,</span>
                <span class="n">clean_kwargs</span><span class="p">,</span>
                <span class="n">current_date</span><span class="p">,</span>
                <span class="n">json_load</span><span class="p">,</span>
                <span class="n">json_dump</span><span class="p">,</span>
                <span class="n">logger</span><span class="p">,</span>
                <span class="p">)</span>
<span class="kn">from</span> <span class="nn">cervmongo.config</span> <span class="kn">import</span> <span class="n">Config</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">motor.motor_asyncio</span> <span class="kn">import</span> <span class="n">AsyncIOMotorClient</span> <span class="k">as</span> <span class="n">MongoClient</span>
    <span class="n">SUPPORT_ASYNCIO_CLIENT</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;motor is not installed. needed if using asyncio&quot;</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">MongoClient</span><span class="p">:</span> <span class="k">pass</span>
    <span class="n">SUPPORT_ASYNCIO_CLIENT</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">motor.motor_tornado</span> <span class="kn">import</span> <span class="n">MotorGridFSBucket</span> <span class="k">as</span> <span class="n">GridFSBucket</span>
    <span class="n">SUPPORT_ASYNCIO_BUCKET</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;tornado is not installed. needed if using asyncio GridFS&quot;</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">GridFSBucket</span><span class="p">:</span> <span class="k">pass</span>
    <span class="n">SUPPORT_ASYNCIO_BUCKET</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="get_async_client"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.get_async_client">[docs]</a><span class="k">def</span> <span class="nf">get_async_client</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">SUPPORT_ASYNCIO_CLIENT</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">SUPPORT_ASYNCIO_CLIENT</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;motor not installed&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">AsyncIOClient</span></div>

<div class="viewcode-block" id="get_async_doc"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.get_async_doc">[docs]</a><span class="k">def</span> <span class="nf">get_async_doc</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">SUPPORT_ASYNCIO_CLIENT</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">SUPPORT_ASYNCIO_CLIENT</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;motor not installed&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">AsyncIODoc</span></div>


<div class="viewcode-block" id="AsyncIOClient"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient">[docs]</a><span class="k">class</span> <span class="nc">AsyncIOClient</span><span class="p">(</span><span class="n">MongoClient</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">High-level AsyncIOMotorClient subclass with additional methods added for ease-of-use,</span>
<span class="sd">having some automated conveniences and default argument values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_MONGO_URI</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="s2">&quot;MONGO_URI&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">_DEFAULT_COLLECTION</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_KWARGS</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_LOGGING_COND_GET</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_LOGGING_COND_POST</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_LOGGING_COND_PUT</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_LOGGING_COND_PATCH</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_LOGGING_COND_DELETE</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mongo_uri</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MONGO_URI</span> <span class="o">=</span> <span class="n">mongo_uri</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MONGO_URI</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MONGO_URI</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_MONGO_URI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MONGO_URI</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span> <span class="o">=</span> <span class="n">default_collection</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_KWARGS</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">kwarg</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">kwarg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;logging_cond_get&#39;</span><span class="p">,</span> <span class="s1">&#39;logging_cond_post&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;logging_cond_put&#39;</span><span class="p">,</span> <span class="s1">&#39;logging_cond_patch&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;logging_cond_delete&#39;</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwarg</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">kwarg</span><span class="p">))</span>

        <span class="n">MongoClient</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MONGO_URI</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_database</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;db detected &#39;</span><span class="si">{}</span><span class="s2">&#39; of type &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">db</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;database not provided in MONGO_URI, assign with method set_database&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;gridfsbucket not instantiated due to missing database&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">global</span> <span class="n">SUPPORT_ASYNCIO_BUCKET</span>
            <span class="k">if</span> <span class="n">SUPPORT_ASYNCIO_BUCKET</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;gridfsbucket instantiated under self.FILES&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">FILES</span> <span class="o">=</span> <span class="n">GridFSBucket</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;gridfsbucket not instantiated due to missing &#39;tornado&#39; package&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">FILES</span> <span class="o">=</span> <span class="n">GridFSBucket</span><span class="p">()</span> <span class="c1"># Using empty object</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;cervmongo.AsyncIOClient&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">_process_record_id_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">one</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;$oid&quot;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">json_load</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="n">one</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">DOC_ID</span><span class="o">.</span><span class="n">__supertype__</span><span class="p">):</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">record</span>
                <span class="n">one</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">record</span> <span class="o">=</span> <span class="n">DOC_ID</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                    <span class="n">one</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;$oid&quot;</span> <span class="ow">in</span> <span class="n">record</span> <span class="ow">or</span> <span class="s2">&quot;$regex&quot;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">json_dump</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">json_load</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="n">one</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">one</span><span class="p">)</span>

<div class="viewcode-block" id="AsyncIOClient.set_database"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.set_database">[docs]</a>    <span class="k">def</span> <span class="nf">set_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="n">Config</span><span class="o">.</span><span class="n">set_mongo_db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_KWARGS</span><span class="p">:</span>
            <span class="n">AsyncIOClient</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mongo_uri</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">MONGO_URI</span><span class="p">,</span> <span class="n">default_collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_KWARGS</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">AsyncIOClient</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mongo_uri</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">MONGO_URI</span><span class="p">,</span> <span class="n">default_collection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncIOClient.COLLECTION"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.COLLECTION">[docs]</a>    <span class="k">def</span> <span class="nf">COLLECTION</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="k">class</span> <span class="nc">CollectionClient</span><span class="p">:</span>
            <span class="n">__parent__</span> <span class="o">=</span> <span class="n">CLIENT</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="c1"># INFO: variables</span>
            <span class="n">_DEFAULT_COLLECTION</span> <span class="o">=</span> <span class="n">collection</span>
            <span class="n">_MONGO_URI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MONGO_URI</span>
            <span class="c1"># INFO: general methods</span>
            <span class="n">GENERATE_ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GENERATE_ID</span>
            <span class="n">COLLECTION</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLLECTION</span>
            <span class="c1"># INFO: GridFS file operations</span>
            <span class="n">UPLOAD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UPLOAD</span>
            <span class="n">DOWNLOAD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWNLOAD</span>
            <span class="n">ERASE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ERASE</span>
            <span class="c1"># INFO: truncated Collection methods</span>
            <span class="n">INDEX</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INDEX</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
            <span class="n">ADD_FIELD</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ADD_FIELD</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
            <span class="n">REMOVE_FIELD</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REMOVE_FIELD</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
            <span class="n">DELETE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
            <span class="n">GET</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
            <span class="n">POST</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
            <span class="n">PUT</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PUT</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
            <span class="n">PATCH</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PATCH</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
            <span class="n">REPLACE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REPLACE</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
            <span class="n">SEARCH</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SEARCH</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
            <span class="n">PAGINATED_QUERY</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PAGINATED_QUERY</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
            <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;&lt;cervmongo.AsyncIOClient.CollectionClient&gt;&quot;</span>
            <span class="k">def</span> <span class="nf">get_client</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">CLIENT</span>
        <span class="k">return</span> <span class="n">CollectionClient</span><span class="p">()</span></div>

<div class="viewcode-block" id="AsyncIOClient.PAGINATION_QUERY"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.PAGINATION_QUERY">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">PAGINATION_QUERY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                <span class="n">sort</span><span class="p">:</span><span class="n">PAGINATION_SORT_FIELDS</span><span class="o">=</span><span class="n">PAGINATION_SORT_FIELDS</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">],</span>
                                <span class="n">after</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">before</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">page</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
                                <span class="n">query</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns paginated results of collection w/ query.</span>

<span class="sd">Available pagination methods:</span>
<span class="sd"> - __Cursor-based (default)__</span>
<span class="sd">    - after</span>
<span class="sd">    - before</span>
<span class="sd">    - limit (results per page, default 20)</span>
<span class="sd"> - __Time-based__ (a datetime field must be selected)</span>
<span class="sd">    - sort (set to datetime field)</span>
<span class="sd">    - after (records after this time)</span>
<span class="sd">    - before (records before this time)</span>
<span class="sd">    - limit (results per page, default 20)</span>
<span class="sd"> - __Offset-based__ (not recommended)</span>
<span class="sd">    - limit (results per page, default 20)</span>
<span class="sd">    - page</span>
<span class="sd">&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_DEFAULT_COLLECTION&#39;</span><span class="p">):</span>
                <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span>
        <span class="k">assert</span> <span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;collection must be of type str&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span>

        <span class="n">sort</span> <span class="o">=</span> <span class="n">sort</span><span class="o">.</span><span class="n">value</span>

        <span class="n">total_docs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sort</span> <span class="o">==</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span>
                <span class="n">pagination_method</span> <span class="o">=</span> <span class="s2">&quot;cursor&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pagination_method</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                                    <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="n">before</span><span class="p">,</span>
                                    <span class="n">after</span><span class="o">=</span><span class="n">after</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pagination_method</span> <span class="o">=</span> <span class="s2">&quot;offset&quot;</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                                    <span class="n">perpage</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
                                    <span class="n">empty</span><span class="o">=</span><span class="p">[])</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span> <span class="n">record</span> <span class="k">async</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">cursor</span> <span class="p">]</span>

        <span class="c1"># INFO: determine &#39;cursor&#39; template</span>
        <span class="k">if</span> <span class="n">sort</span> <span class="o">==</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;_</span><span class="si">{_id}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{date}</span><span class="s2">_</span><span class="si">{_id}</span><span class="s2">&quot;</span>

        <span class="n">new_after</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">new_before</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">sort</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="n">limit</span><span class="p">:</span>
                <span class="n">new_after</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_id</span><span class="o">=</span><span class="n">_id</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>

            <span class="n">_id</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">sort</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">)):</span>
                <span class="n">new_before</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_id</span><span class="o">=</span><span class="n">_id</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;pagination_method&quot;</span><span class="p">:</span> <span class="n">pagination_method</span><span class="p">,</span>
                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">JSON_DUMP</span><span class="p">(</span><span class="n">query</span><span class="p">),</span>
                <span class="s2">&quot;unique_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span><span class="p">,</span>
                <span class="s2">&quot;sort&quot;</span><span class="p">:</span> <span class="n">sort</span><span class="p">,</span>
                <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total_docs</span><span class="p">,</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limit</span>
                <span class="p">}</span>
            <span class="p">}</span>

        <span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoint</span>

        <span class="c1"># TODO: Refactor</span>
        <span class="k">if</span> <span class="n">pagination_method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">):</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;cursors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="s2">&quot;after&quot;</span><span class="p">:</span> <span class="n">new_after</span><span class="p">,</span>
                  <span class="s2">&quot;before&quot;</span><span class="p">:</span> <span class="n">new_before</span>
                <span class="p">}</span>
            <span class="n">before_url_template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{endpoint}</span><span class="s2">?sort=</span><span class="si">{sort}</span><span class="s2">&amp;limit=</span><span class="si">{limit}</span><span class="s2">&amp;before=</span><span class="si">{before}</span><span class="s2">&quot;</span>
            <span class="n">after_url_template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{endpoint}</span><span class="s2">?sort=</span><span class="si">{sort}</span><span class="s2">&amp;limit=</span><span class="si">{limit}</span><span class="s2">&amp;after=</span><span class="si">{after}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># INFO: pagination_method == &quot;offset&quot;</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;cursors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="s2">&quot;prev_page&quot;</span><span class="p">:</span> <span class="n">page</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="s2">&quot;next_page&quot;</span><span class="p">:</span> <span class="n">page</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">*</span> <span class="n">limit</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">total_docs</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">}</span>
            <span class="n">before_url_template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{endpoint}</span><span class="s2">?sort=</span><span class="si">{sort}</span><span class="s2">&amp;limit=</span><span class="si">{limit}</span><span class="s2">&amp;page=</span><span class="si">{page}</span><span class="s2">&quot;</span>
            <span class="n">after_url_template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{endpoint}</span><span class="s2">?sort=</span><span class="si">{sort}</span><span class="s2">&amp;limit=</span><span class="si">{limit}</span><span class="s2">&amp;page=</span><span class="si">{page}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">new_before</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;previous&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">before_url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                    <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span>
                                                                    <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                                                                    <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
                                                                    <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
                                                                    <span class="n">after</span><span class="o">=</span><span class="n">new_after</span><span class="p">,</span>
                                                                    <span class="n">before</span><span class="o">=</span><span class="n">new_before</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;previous&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">new_after</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;next&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">after_url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                    <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span>
                                                                    <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                                                                    <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span>
                                                                    <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
                                                                    <span class="n">after</span><span class="o">=</span><span class="n">new_after</span><span class="p">,</span>
                                                                    <span class="n">before</span><span class="o">=</span><span class="n">new_before</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;next&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">response</span></div>
    <span class="n">PAGINATION_QUERY</span><span class="o">.</span><span class="n">clean_kwargs</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">_clean_kwargs</span><span class="p">(</span><span class="n">ONLY</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="s2">&quot;sort&quot;</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">,</span>
                                            <span class="s2">&quot;before&quot;</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">,</span> <span class="s2">&quot;endpoint&quot;</span><span class="p">,</span> <span class="s2">&quot;query&quot;</span><span class="p">),</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="AsyncIOClient.GENERATE_ID"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.GENERATE_ID">[docs]</a>    <span class="k">def</span> <span class="nf">GENERATE_ID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DOC_ID</span><span class="p">(</span><span class="n">_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DOC_ID</span><span class="p">()</span></div>

<div class="viewcode-block" id="AsyncIOClient.UPLOAD"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.UPLOAD">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">UPLOAD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content_type</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extension</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">file_and_fileobj</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_file_meta_information</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="n">extension</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">file_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">upload_from_stream</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file_id</span></div>

<div class="viewcode-block" id="AsyncIOClient.ERASE"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.ERASE">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">ERASE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename_or_id</span><span class="p">,</span> <span class="n">revision</span><span class="p">:</span><span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">fs_doc</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWNLOAD</span><span class="p">(</span><span class="n">filename_or_id</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">fs_doc</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">fs_doc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="AsyncIOClient.DOWNLOAD"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.DOWNLOAD">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">DOWNLOAD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename_or_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">revision</span><span class="p">:</span><span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">skip</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span><span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">query</span><span class="p">):</span>
        <span class="n">revision</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">revision</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename_or_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename_or_id</span><span class="p">,</span> <span class="n">DOC_ID</span><span class="o">.</span><span class="n">__supertype__</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">open_download_stream</span><span class="p">(</span><span class="n">filename_or_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">open_download_stream_by_name</span><span class="p">(</span><span class="n">filename_or_id</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">no_cursor_timeout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncIOClient.DELETE"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.DELETE">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">DELETE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">soft</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_database</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_DEFAULT_COLLECTION&#39;</span><span class="p">):</span>
                <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span>
        <span class="k">assert</span> <span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;collection must be of type str&quot;</span>

        <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span>

        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_record_id_type</span><span class="p">(</span><span class="n">record</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">soft</span><span class="p">:</span>
            <span class="n">data_record</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">PUT</span><span class="p">(</span><span class="s2">&quot;deleted.&quot;</span><span class="o">+</span><span class="n">collection</span><span class="p">,</span> <span class="n">data_record</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">data_record</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">PUT</span><span class="p">(</span><span class="s2">&quot;deleted.&quot;</span><span class="o">+</span><span class="n">collection</span><span class="p">,</span> <span class="n">data_record</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ObjectId</span><span class="p">)):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">collection</span><span class="o">.</span><span class="n">delete_one</span><span class="p">({</span><span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="n">record</span><span class="p">})</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">collection</span><span class="o">.</span><span class="n">delete_one</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">await</span> <span class="n">collection</span><span class="o">.</span><span class="n">delete_one</span><span class="p">({</span><span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="n">_id</span><span class="p">}))</span>
            <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="AsyncIOClient.INDEX"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.INDEX">[docs]</a>    <span class="k">def</span> <span class="nf">INDEX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">unique</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reindex</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_database</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_DEFAULT_COLLECTION&#39;</span><span class="p">):</span>
                <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span>
        <span class="k">assert</span> <span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;collection must be of type str&quot;</span>

        <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span>

        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">Index</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;Asc&quot;</span> <span class="k">if</span> <span class="n">sort</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;Desc&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">index_information</span><span class="p">():</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">create_index</span><span class="p">([</span>
                    <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">sort</span><span class="p">)],</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="n">unique</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1">#print((_traceback()))</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="AsyncIOClient.ADD_FIELD"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.ADD_FIELD">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">ADD_FIELD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_DEFAULT_COLLECTION&#39;</span><span class="p">):</span>
                <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span>
        <span class="k">assert</span> <span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;collection must be of type str&quot;</span>

        <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">field</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$exists&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">{</span>
                <span class="n">data</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">empty</span><span class="o">=</span><span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">empty</span><span class="o">=</span><span class="p">[])</span>

        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATCH</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">field</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="n">data</span><span class="p">]}})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATCH</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">field</span><span class="p">:</span> <span class="n">value</span><span class="p">}})</span></div>

<div class="viewcode-block" id="AsyncIOClient.REMOVE_FIELD"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.REMOVE_FIELD">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">REMOVE_FIELD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span>
        <span class="k">assert</span> <span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;collection must be of type str&quot;</span>
        <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">field</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$exists&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}})</span>
        <span class="n">records</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">lst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATCH</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;$unset&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="n">value</span><span class="p">}})</span></div>

<div class="viewcode-block" id="AsyncIOClient.GET"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.GET">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">GET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">record</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="p">{},</span> <span class="n">sort</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="n">lst</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">page</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">perpage</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">after</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">before</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">one</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">distinct</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_database</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span>
        <span class="k">assert</span> <span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;collection must be of type str&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">)):</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="p">[</span><span class="n">collection</span><span class="p">]</span>

        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_record_id_type</span><span class="p">(</span><span class="n">record</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">number_of_results</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="n">record</span><span class="p">:</span>
            <span class="n">record</span><span class="p">,</span> <span class="n">_one</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_record_id_type</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            <span class="n">one</span> <span class="o">=</span> <span class="n">_one</span> <span class="k">if</span> <span class="n">_one</span> <span class="k">else</span> <span class="n">one</span>
            <span class="k">if</span> <span class="n">one</span><span class="p">:</span>
                <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">record</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">query</span><span class="p">,</span> <span class="ow">not</span> <span class="n">record</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">search</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">await</span> <span class="n">collection</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">lst</span><span class="p">:</span>
                    <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="n">collection</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">distinct</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">cursor</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">perpage</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">perpage</span>
                    <span class="n">cursor</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">sort</span><span class="p">)])</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">total</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">perpage</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">limit</span><span class="p">:</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$and&quot;</span><span class="p">:</span> <span class="p">[</span>
                                <span class="n">query</span>
                            <span class="p">]}</span>
                    <span class="k">if</span> <span class="n">after</span> <span class="ow">or</span> <span class="n">before</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">after</span><span class="p">:</span>
                            <span class="n">sort_value</span><span class="p">,</span> <span class="n">_id_value</span> <span class="o">=</span> <span class="n">after</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                            <span class="n">_id_value</span> <span class="o">=</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">_id_value</span><span class="p">)</span>
                            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;$and&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$or&quot;</span><span class="p">:</span> <span class="p">[</span>
                                            <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$lt&quot;</span><span class="p">:</span> <span class="n">_id_value</span><span class="p">}}</span>
                                        <span class="p">]})</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span>
                                <span class="n">sort_value</span> <span class="o">=</span> <span class="n">dateparse</span><span class="p">(</span><span class="n">sort_value</span><span class="p">)</span>
                                <span class="n">query</span><span class="p">[</span><span class="s2">&quot;$and&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;$or&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$lt&quot;</span><span class="p">:</span> <span class="n">sort_value</span><span class="p">},</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$lt&quot;</span><span class="p">:</span> <span class="n">_id_value</span><span class="p">}})</span>
                        <span class="k">elif</span> <span class="n">before</span><span class="p">:</span>
                            <span class="n">sort_value</span><span class="p">,</span> <span class="n">_id_value</span> <span class="o">=</span> <span class="n">before</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                            <span class="n">_id_value</span> <span class="o">=</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">_id_value</span><span class="p">)</span>
                            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;$and&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$or&quot;</span><span class="p">:</span> <span class="p">[</span>
                                            <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$gt&quot;</span><span class="p">:</span> <span class="n">_id_value</span><span class="p">}}</span>
                                        <span class="p">]})</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span>
                                <span class="n">sort_value</span> <span class="o">=</span> <span class="n">dateparse</span><span class="p">(</span><span class="n">sort_value</span><span class="p">)</span>
                                <span class="n">query</span><span class="p">[</span><span class="s2">&quot;$and&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;$or&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$gt&quot;</span><span class="p">:</span> <span class="n">sort_value</span><span class="p">},</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$gt&quot;</span><span class="p">:</span> <span class="n">_id_value</span><span class="p">}})</span>

                    <span class="n">cursor</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">one</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="k">await</span> <span class="n">collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span> <span class="k">if</span> <span class="n">val</span> <span class="k">else</span> <span class="n">empty</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cursor</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">sort</span><span class="p">)])</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">search</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">await</span> <span class="n">cursor</span><span class="o">.</span><span class="n">count_documents</span><span class="p">({</span><span class="s2">&quot;$text&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$search&quot;</span><span class="p">:</span> <span class="n">search</span><span class="p">}}))</span>
                    <span class="k">elif</span> <span class="n">lst</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">await</span> <span class="n">collection</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">distinct</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;$text&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$search&quot;</span><span class="p">:</span> <span class="n">search</span><span class="p">}}))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cursor</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;$text&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$search&quot;</span><span class="p">:</span> <span class="n">search</span><span class="p">}})</span>
                        <span class="k">if</span> <span class="n">perpage</span><span class="p">:</span>
                            <span class="n">total</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">perpage</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">sort</span><span class="p">)])</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">total</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">perpage</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">sort</span><span class="p">)]))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="n">collection</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">&#39;textIndex&#39;</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="n">lst</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">distinct</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">perpage</span><span class="p">:</span>
                            <span class="n">total</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">perpage</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">sort</span><span class="p">)])</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">total</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">perpage</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">sort</span><span class="p">)]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;unidentified error&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">number_of_results</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="AsyncIOClient.SEARCH"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.SEARCH">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">SEARCH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">search</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_DEFAULT_COLLECTION&#39;</span><span class="p">):</span>
                <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span>
        <span class="k">assert</span> <span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;collection must be of type str&quot;</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncIOClient.PUT"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.PUT">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">PUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_database</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_DEFAULT_COLLECTION&#39;</span><span class="p">):</span>
                <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span>
        <span class="k">assert</span> <span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;collection must be of type str&quot;</span>

        <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">many</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">collection</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;_id&quot;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">tool</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;db_put_noid&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">record</span><span class="p">,</span>
                                             <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">current_datetime</span><span class="p">()})</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">record</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncIOClient.REPLACE"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.REPLACE">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">REPLACE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">replacement</span><span class="p">:</span><span class="nb">dict</span><span class="p">,</span> <span class="n">upsert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_database</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_DEFAULT_COLLECTION&#39;</span><span class="p">):</span>
                <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span>
        <span class="k">assert</span> <span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;collection must be of type str&quot;</span>

        <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span>

        <span class="k">return</span> <span class="k">await</span> <span class="n">collection</span><span class="o">.</span><span class="n">replace_one</span><span class="p">({</span><span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="n">original</span><span class="p">},</span>
                    <span class="n">replacement</span><span class="p">,</span> <span class="n">upsert</span><span class="o">=</span><span class="n">upsert</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncIOClient.PATCH"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIOClient.PATCH">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">PATCH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">upsert</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">multi</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_database</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_DEFAULT_COLLECTION&#39;</span><span class="p">):</span>
                <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span>
        <span class="k">assert</span> <span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;collection must be of type str&quot;</span>

        <span class="n">collection</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">w</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">WRITE</span> <span class="o">=</span> <span class="n">WriteConcern</span><span class="p">(</span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">_collection</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">with_options</span><span class="p">(</span><span class="n">write_concern</span><span class="o">=</span><span class="n">WRITE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_collection</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1"># TODO: optional, may not incorporate</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_record_id_type</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">multi</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_collection</span><span class="o">.</span><span class="n">update_many</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">upsert</span><span class="o">=</span><span class="n">upsert</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">results</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ObjectId</span><span class="p">)):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="n">original</span><span class="p">}</span>
            <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;$setOnInsert&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span>
            <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">upsert</span><span class="o">=</span><span class="n">upsert</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">original</span><span class="p">):</span>
                <span class="n">_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_record_id_type</span><span class="p">(</span><span class="n">_id</span><span class="p">)</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="n">_id</span><span class="p">}</span>
                <span class="n">updates</span><span class="p">[</span><span class="s2">&quot;$setOnInsert&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">updates</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">upsert</span><span class="o">=</span><span class="n">upsert</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">other</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;reindex&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;db&#39;</span><span class="p">:</span> <span class="n">db</span><span class="p">,</span>
                                        <span class="s1">&#39;collection&#39;</span><span class="p">:</span> <span class="n">collection</span><span class="p">,</span>
                                        <span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="n">current_datetime</span><span class="p">()})</span>
            <span class="k">return</span> <span class="n">results</span></div></div>



<div class="viewcode-block" id="AsyncIODoc"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc">[docs]</a><span class="k">class</span> <span class="nc">AsyncIODoc</span><span class="p">(</span><span class="n">AsyncIOClient</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Custom MongoClient subclass with customizations for creating</span>
<span class="sd">        standardized documents and adding json schema validation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_DEFAULT_COLLECTION</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_UNIQUE_ID</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_TEMPLATE_PATH</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_SCHEMA_PATH</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_MARSHMALLOW</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_DEFAULT_VALUES</span><span class="p">:</span><span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_RESTRICTED_KEYS</span><span class="p">:</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">template_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unique_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># INFO: set default collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span> <span class="o">=</span> <span class="n">collection</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span><span class="p">,</span> <span class="s2">&quot;collection must be of type str&quot;</span>
        <span class="c1"># INFO: location for sample record, used as template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_TEMPLATE_PATH</span> <span class="o">=</span> <span class="n">template_path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TEMPLATE_PATH</span>
        <span class="c1"># INFO: path to validation schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SCHEMA_PATH</span> <span class="o">=</span> <span class="n">schema_path</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SCHEMA_PATH</span>
        <span class="c1"># INFO: sets the unique id field for the document, if any (cannot be _id)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span> <span class="o">=</span> <span class="n">unique_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span>

        <span class="k">for</span> <span class="n">kwarg</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">kwarg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;marshmallow&#39;</span><span class="p">,</span> <span class="s1">&#39;default_values&#39;</span><span class="p">,</span> <span class="s1">&#39;restricted_keys&#39;</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwarg</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">kwarg</span><span class="p">))</span>

        <span class="c1"># Initial Record object with template else start blank dict</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TEMPLATE_PATH</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_TEMPLATE_PATH</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">template_full_path</span> <span class="o">=</span> <span class="n">os_path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">JSON_SAMPLE_PATH</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TEMPLATE_PATH</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template_full_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file1</span><span class="p">:</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="n">json_load</span><span class="p">(</span><span class="n">file1</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_TEMPLATE_PATH</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TEMPLATE_PATH</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;_TEMPLATE_PATH is invalid type &#39;</span><span class="si">{}</span><span class="s2">&#39;, valid types are dict and str&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_TEMPLATE_PATH</span><span class="p">)))</span>
            <span class="n">parent_found</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__parent__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">parent_found</span><span class="p">:</span>
                <span class="n">parent_full_path</span> <span class="o">=</span> <span class="n">os_path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">JSON_SAMPLE_PATH</span><span class="p">,</span> <span class="n">parent_found</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">parent_full_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file1</span><span class="p">:</span>
                    <span class="n">parent</span> <span class="o">=</span> <span class="n">json_load</span><span class="p">(</span><span class="n">file1</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">parent</span>
                <span class="n">parent_found</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__parent__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">template</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># INFO: Load schema else start blank dict to add manual validation entries</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SCHEMA_PATH</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os_path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">JSON__SCHEMA_PATH</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SCHEMA_PATH</span><span class="p">))</span> <span class="k">as</span> <span class="n">file1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">json_load</span><span class="p">(</span><span class="n">file1</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">AsyncIOClient</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MONGO_URI</span><span class="p">)</span>

        <span class="c1"># INFO: If class has a _UNIQUE_ID assigned, create unique index</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">INDEX</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span><span class="p">,</span>
                                                        <span class="n">sort</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_process_restrictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;removes restricted keys from record and return record&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">record</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">,</span> <span class="s2">&quot;Needs to be a dictionary, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">record</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RESTRICTED_KEYS</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RESTRICTED_KEYS</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;shortname for _process_restrictions&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_restrictions</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="n">record</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_unique_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{total}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">dateparse</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_guess_corresponding_fieldname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_type</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span> <span class="n">related_field</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">time_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_type</span> <span class="ow">in</span> <span class="n">time_fields</span><span class="p">:</span>
            <span class="c1"># NOTE: a timestamp is &#39;mostly&#39; accompanied by a user or relation</span>
            <span class="k">if</span> <span class="n">related_field</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;_&quot;</span> <span class="ow">in</span> <span class="n">related_field</span><span class="p">:</span>
                    <span class="n">field_parts</span> <span class="o">=</span> <span class="n">related_field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">related_field</span><span class="p">:</span>
                    <span class="n">field_parts</span> <span class="o">=</span> <span class="n">related_field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">field_parts</span> <span class="o">=</span> <span class="n">related_field</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">field_part</span> <span class="ow">in</span> <span class="n">field_parts</span><span class="p">:</span>
                    <span class="n">field_part</span> <span class="o">=</span> <span class="n">field_part</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; _-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">field_part</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">time_fields</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_part</span><span class="si">}</span><span class="s2">_by&quot;</span>
                <span class="k">return</span> <span class="s2">&quot;for&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;by&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># NOTE: an unknown type field has a timestamp pairing or desc</span>
            <span class="k">if</span> <span class="n">related_field</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">related_field</span><span class="si">}</span><span class="s2">_description&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;field_description&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_related_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">additional</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">additional</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="n">field</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">})</span>

        <span class="n">record</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="n">value</span><span class="p">},</span> <span class="n">fields</span><span class="o">=</span><span class="n">additional</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="p">{})</span>
        <span class="k">assert</span> <span class="n">record</span><span class="p">,</span> <span class="s1">&#39;Error: No record found&#39;</span>

        <span class="n">record</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
        <span class="n">record</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="n">record</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">record</span>

<div class="viewcode-block" id="AsyncIODoc.load"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.load">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># If _id specified on init, load actual record versus blank template</span>
        <span class="k">if</span> <span class="n">_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span><span class="p">:</span> <span class="n">_id</span><span class="p">},</span> <span class="n">one</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span><span class="p">,</span> <span class="n">_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="n">StandardResponse</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">),</span>
                    <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;unsaved&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;saved&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unique_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span> <span class="k">else</span> <span class="s2">&quot;_id&quot;</span>
                <span class="p">})</span></div>

<div class="viewcode-block" id="AsyncIODoc.view"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.view">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_id</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">StandardResponse</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">StandardResponse</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span><span class="p">:</span> <span class="n">_id</span><span class="p">},</span> <span class="n">one</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="p">{})),</span>
                            <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;unique_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span> <span class="k">else</span> <span class="s2">&quot;_id&quot;</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">StandardResponse</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">_id</span><span class="p">},</span> <span class="n">one</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="p">{})),</span>
                            <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;unique_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span> <span class="k">else</span> <span class="s2">&quot;_id&quot;</span>
                        <span class="p">}</span>
                    <span class="p">)</span></div>

<div class="viewcode-block" id="AsyncIODoc.reload"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.reload">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">),</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;unique_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span> <span class="k">else</span> <span class="s2">&quot;_id&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="AsyncIODoc.id"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.id">[docs]</a>    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncIODoc.create"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.create">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trigger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{total}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;Cannot use create method on</span>
<span class="s2"> an existing record. Use patch method instead.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MARSHMALLOW</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_MARSHMALLOW</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_unique_id</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">trigger</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">),</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;unique_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span><span class="p">,</span> <span class="s2">&quot;collection&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_COLLECTION</span><span class="p">,</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_UNIQUE_ID</span><span class="p">]}</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="AsyncIODoc.push"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.push">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">),</span> <span class="s2">&quot;&quot;&quot;Cannot use push method on</span>
<span class="s2"> a non-existing record. Use create method instead.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;_id&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATCH</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;$push&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">})</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">),</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;push&quot;</span><span class="p">,</span>
                <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;push a value to end of array, not set&quot;</span><span class="p">,</span>
                <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="AsyncIODoc.pull"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.pull">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">pull</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">),</span> <span class="s2">&quot;&quot;&quot;Cannot use pull method on</span>
<span class="s2"> a non-existing record. Use create method instead.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;_id&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATCH</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span> <span class="p">{</span><span class="s2">&quot;$pull&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">})</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">),</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;pull&quot;</span><span class="p">,</span>
                <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;pull all instances of a value from an array&quot;</span><span class="p">,</span>
                <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="AsyncIODoc.increment"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.increment">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">),</span> <span class="s2">&quot;&quot;&quot;Cannot use increment method on</span>
<span class="s2"> a non-existing record. Use create method instead.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;_id&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>

        <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]})</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATCH</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;$inc&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">},</span> <span class="n">multi</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">),</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;increment&quot;</span><span class="p">,</span>
                <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;increment the integer fields by the amount provided&quot;</span><span class="p">,</span>
                <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">keys</span><span class="p">,</span>
                <span class="s2">&quot;increment&quot;</span><span class="p">:</span> <span class="n">values</span>
                <span class="p">}</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="AsyncIODoc.update"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.update">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">),</span> <span class="s2">&quot;&quot;&quot;Cannot use update method on</span>
<span class="s2"> a non-existing record. Use create method instead.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;_id&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>

        <span class="n">query</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]})</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">old_values</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="p">]</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATCH</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">},</span> <span class="n">multi</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

        <span class="n">new_values</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="p">]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">),</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;update&quot;</span><span class="p">,</span>
                <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;replace existing field values with new values&quot;</span><span class="p">,</span>
                <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">keys</span><span class="p">,</span>
                <span class="s2">&quot;values_old&quot;</span><span class="p">:</span> <span class="n">old_values</span><span class="p">,</span>
                <span class="s2">&quot;values_new&quot;</span><span class="p">:</span> <span class="n">new_values</span>
                <span class="p">}</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="AsyncIODoc.patch"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.patch">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trigger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">),</span> <span class="s2">&quot;&quot;&quot;Cannot use patch method on</span>
<span class="s2"> a non-existing record.Use create method instead.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;_id&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MARSHMALLOW</span><span class="p">:</span>
            <span class="n">_MARSHMALLOW</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">partial</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">trigger</span><span class="o">=</span><span class="n">trigger</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">),</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="AsyncIODoc.save"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.save">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_VALUES</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_VALUES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">):</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MARSHMALLOW</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_MARSHMALLOW</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_id</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATCH</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">PUT</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">inserted_id</span>
            <span class="k">if</span> <span class="n">trigger</span><span class="p">:</span>
                <span class="n">trigger</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">),</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="AsyncIODoc.close"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.close">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: clean closing logic</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">,</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="AsyncIODoc.add_relation"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.add_relation">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">add_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_related_record</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">),</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;relation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="AsyncIODoc.add_timestamp"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.add_timestamp">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">add_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relation</span><span class="p">:</span><span class="nb">dict</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timestamp</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">relation</span><span class="p">:</span>
            <span class="n">related_key</span> <span class="o">=</span> <span class="n">relation</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_guess_corresponding_fieldname</span><span class="p">(</span><span class="n">_type</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="n">related_field</span><span class="o">=</span><span class="n">key</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_relation</span><span class="p">(</span><span class="n">related_key</span><span class="p">,</span> <span class="o">**</span><span class="n">relation</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">),</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="AsyncIODoc.add_object"><a class="viewcode-back" href="../../cervmongo.html#cervmongo.aio.AsyncIODoc.add_object">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">add_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">object_name</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">object_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">GENERATE_ID</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template_path</span> <span class="o">=</span> <span class="n">os_path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_TEMPLATE_PATH</span><span class="p">,</span> <span class="n">object_name</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">template_path</span><span class="p">),</span> <span class="s2">&quot;path does not exist&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_util</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">file1</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">GENERATE_ID</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_p_r</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">),</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;unsaved&quot;</span><span class="p">}</span>
            <span class="p">}</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Anthony &#34;antcer1213&#34; Cervantes

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>